<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التحقق من التحديثات - iBrowser</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/pages.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-container">
        <div class="page-header">
            <div class="page-logo">
                <img src="../assets/logo/worksuite-logo.png" alt="iBrowser Logo">
                <h1>iBrowser</h1>
            </div>
            <button type="button" id="close-page" class="close-button"><i class="fas fa-times"></i></button>
        </div>

        <div class="page-content">
            <h2>التحقق من التحديثات</h2>

            <div class="update-container">
                <div class="current-version">
                    <h3>الإصدار الحالي</h3>
                    <div class="version-info">
                        <span class="version-number">1.0.5</span>
                        <span class="version-date">تاريخ الإصدار: 5 مايو 2025</span>
                    </div>
                </div>

                <div class="update-status" id="update-status">
                    <div class="checking-updates">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <p>جاري التحقق من وجود تحديثات...</p>
                    </div>
                </div>

                <div class="update-actions">
                    <button type="button" id="check-updates-btn" class="primary-button">
                        <i class="fas fa-sync-alt"></i>
                        التحقق من التحديثات
                    </button>
                </div>

                <div class="update-history">
                    <h3>سجل التحديثات</h3>

                    <div class="update-entry">
                        <div class="update-entry-header">
                            <span class="update-version">الإصدار 1.0.5</span>
                            <span class="update-date">5 مايو 2025</span>
                        </div>
                        <div class="update-entry-content">
                            <h4>تحسينات وإضافات</h4>
                            <ul>
                                <li>تحسين صفحة التحقق من التحديثات مع إضافة خطوات التحقق المرئية</li>
                                <li>إضافة تنزيل وتثبيت التحديثات تلقائياً</li>
                                <li>تحسين واجهة المستخدم لصفحة التحديثات مع تأثيرات انتقالية</li>
                                <li>إضافة علامة الصح المتحركة عند استخدام أحدث إصدار</li>
                                <li>تحسين شريط التقدم أثناء تنزيل التحديثات</li>
                                <li>إصلاح مشكلة في عرض حالة التحديث</li>
                            </ul>
                        </div>
                    </div>

                    <div class="update-entry">
                        <div class="update-entry-header">
                            <span class="update-version">الإصدار 1.0.4</span>
                            <span class="update-date">5 مايو 2025</span>
                        </div>
                        <div class="update-entry-content">
                            <h4>تحسينات وإصلاحات</h4>
                            <ul>
                                <li>تحسين شريط الحالة بإضافة تأثيرات انتقالية</li>
                                <li>تحسين عرض التاريخ الهجري</li>
                                <li>إضافة تأثيرات انتقالية للتبويبات</li>
                                <li>تحسين إدارة المفضلة مع دعم المجلدات</li>
                                <li>إضافة مؤشر تحميل للتبويبات الجديدة</li>
                                <li>تحسين عرض أيقونات المواقع في التبويبات</li>
                            </ul>
                        </div>
                    </div>

                    <div class="update-entry">
                        <div class="update-entry-header">
                            <span class="update-version">الإصدار 1.0.3</span>
                            <span class="update-date">5 مايو 2025</span>
                        </div>
                        <div class="update-entry-content">
                            <h4>تحسينات وإصلاحات</h4>
                            <ul>
                                <li>نقل القائمة العلوية إلى جانب البحث لتجنب التكرار</li>
                                <li>إصلاح مشكلة في التحقق من البحث</li>
                                <li>تحسين تنظيم القائمة المنسدلة وتقسيمها إلى أقسام</li>
                                <li>إضافة اختصارات لوحة المفاتيح للوظائف الشائعة</li>
                                <li>إصلاح مشكلة في عمل بعض الصفحات</li>
                                <li>تحسين تنسيق القائمة المنسدلة</li>
                            </ul>
                        </div>
                    </div>

                    <div class="update-entry">
                        <div class="update-entry-header">
                            <span class="update-version">الإصدار 1.0.2</span>
                            <span class="update-date">5 مايو 2025</span>
                        </div>
                        <div class="update-entry-content">
                            <h4>تحسينات وإصلاحات</h4>
                            <ul>
                                <li>تحسين نظام التحديثات التلقائية</li>
                                <li>إصلاح مشكلة في عرض القوائم المنسدلة</li>
                                <li>إضافة دعم للتحديثات التلقائية عبر GitHub Releases</li>
                                <li>تحسين نظام التنبيهات والإشعارات</li>
                                <li>إصلاح مشكلة في حفظ الإعدادات</li>
                                <li>إضافة خيارات تخصيص إضافية</li>
                            </ul>
                        </div>
                    </div>

                    <div class="update-entry">
                        <div class="update-entry-header">
                            <span class="update-version">الإصدار 1.0.1</span>
                            <span class="update-date">5 مايو 2025</span>
                        </div>
                        <div class="update-entry-content">
                            <h4>الإصدار الأولي</h4>
                            <ul>
                                <li>إطلاق النسخة الأولى من متصفح iBrowser</li>
                                <li>دعم التبويبات المتعددة</li>
                                <li>إدارة المفضلة وسجل التصفح</li>
                                <li>دعم وضع توفير البيانات</li>
                                <li>عرض التاريخ الهجري والميلادي</li>
                                <li>أزرار الوصول السريع للمواقع الشائعة</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('close-page').addEventListener('click', () => {
            window.close();
        });

        // تحديث الإصدار الحالي من package.json
        function updateCurrentVersion() {
            // في الواقع، يجب أن يتم جلب هذه المعلومات من العملية الرئيسية
            // لكن في هذا المثال سنستخدم القيمة المحددة مسبقًا
            const versionNumber = document.querySelector('.version-number');
            const versionDate = document.querySelector('.version-date');

            if (versionNumber && versionDate) {
                versionNumber.textContent = '1.0.5';
                versionDate.textContent = 'تاريخ الإصدار: 5 مايو 2025';
            }
        }

        // التحقق من التحديثات
        document.getElementById('check-updates-btn').addEventListener('click', () => {
            const updateStatus = document.getElementById('update-status');

            // عرض حالة التحقق مع تأثير انتقالي
            updateStatus.innerHTML = `
                <div class="checking-updates animate__animated animate__fadeIn">
                    <i class="fas fa-sync-alt fa-spin"></i>
                    <p>جاري التحقق من وجود تحديثات...</p>
                </div>
            `;

            // إرسال طلب التحقق من التحديثات إلى العملية الرئيسية
            window.api.send('check-for-updates');
        });

        // استماع لحالة التحديث من العملية الرئيسية
        window.api.receive('update-status', (data) => {
            console.log('تم استلام حالة التحديث:', data);
            const updateStatus = document.getElementById('update-status');

            switch (data.status) {
                case 'checking':
                    updateStatus.innerHTML = `
                        <div class="checking-updates animate__animated animate__fadeIn">
                            <div class="checking-animation">
                                <div class="spinner-border"></div>
                            </div>
                            <p>جاري التحقق من وجود تحديثات...</p>
                            <div class="checking-steps">
                                <div class="checking-step active">
                                    <span class="step-number">1</span>
                                    <span class="step-text">الاتصال بالخادم</span>
                                    <i class="fas fa-check-circle step-icon"></i>
                                </div>
                                <div class="checking-step">
                                    <span class="step-number">2</span>
                                    <span class="step-text">التحقق من الإصدار</span>
                                    <i class="fas fa-check-circle step-icon"></i>
                                </div>
                                <div class="checking-step">
                                    <span class="step-number">3</span>
                                    <span class="step-text">تحليل البيانات</span>
                                    <i class="fas fa-check-circle step-icon"></i>
                                </div>
                            </div>
                        </div>
                    `;

                    // محاكاة تقدم خطوات التحقق
                    setTimeout(() => {
                        const steps = document.querySelectorAll('.checking-step');
                        if (steps.length >= 2) {
                            steps[1].classList.add('active');
                        }

                        setTimeout(() => {
                            if (steps.length >= 3) {
                                steps[2].classList.add('active');
                            }
                        }, 800);
                    }, 600);
                    break;

                case 'available':
                    // تنسيق ملاحظات الإصدار إذا كانت موجودة
                    let releaseNotes = '';
                    if (data.info && data.info.releaseNotes) {
                        if (typeof data.info.releaseNotes === 'string') {
                            // إذا كانت ملاحظات الإصدار نصًا
                            releaseNotes = `<p class="release-notes">${data.info.releaseNotes}</p>`;
                        } else if (Array.isArray(data.info.releaseNotes)) {
                            // إذا كانت ملاحظات الإصدار مصفوفة
                            releaseNotes = `
                                <div class="release-notes-container">
                                    <h4>ملاحظات الإصدار:</h4>
                                    <ul class="release-notes">
                                        ${data.info.releaseNotes.map(note => `<li>${note}</li>`).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                    }

                    updateStatus.innerHTML = `
                        <div class="update-available animate__animated animate__fadeIn">
                            <div class="update-icon-container">
                                <i class="fas fa-arrow-circle-up"></i>
                                <span class="update-badge">${data.info.version}</span>
                            </div>
                            <p class="update-title">يوجد تحديث جديد متاح!</p>
                            <div class="update-info">
                                <div class="update-info-item">
                                    <i class="fas fa-code-branch"></i>
                                    <span>الإصدار الجديد: <strong>${data.info.version}</strong></span>
                                </div>
                                <div class="update-info-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>تاريخ الإصدار: <strong>${new Date(data.info.releaseDate).toLocaleDateString('ar-SA')}</strong></span>
                                </div>
                            </div>
                            ${releaseNotes}
                            <button id="download-update-btn" class="primary-button">
                                <i class="fas fa-download"></i>
                                تنزيل وتثبيت التحديث تلقائياً
                            </button>
                            <div id="download-progress" class="progress-container" style="display: none;">
                                <div class="progress-status">
                                    <span class="progress-status-text">جاري التنزيل...</span>
                                    <span class="progress-text">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    `;

                    // إضافة مستمع حدث لزر التنزيل
                    document.getElementById('download-update-btn').addEventListener('click', () => {
                        const downloadButton = document.getElementById('download-update-btn');
                        const downloadProgress = document.getElementById('download-progress');

                        // تغيير نص الزر وتعطيله
                        downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التنزيل...';
                        downloadButton.disabled = true;
                        downloadButton.classList.add('disabled');

                        // إظهار شريط التقدم
                        downloadProgress.style.display = 'block';

                        // بدء تنزيل التحديث
                        window.api.send('download-update');
                    });
                    break;

                case 'not-available':
                    // إيقاف أيقونة التحميل وإظهار رسالة "أنت تستخدم أحدث إصدار"
                    updateStatus.innerHTML = `
                        <div class="up-to-date animate__animated animate__fadeIn">
                            <div class="check-animation">
                                <div class="circle-loader">
                                    <div class="checkmark draw"></div>
                                </div>
                            </div>
                            <p>تم التحقق بنجاح!</p>
                            <p class="success-message">أنت الآن تستخدم أحدث إصدار من iBrowser!</p>
                            <span class="last-checked">آخر تحقق: ${new Date().toLocaleString('ar-SA')}</span>
                        </div>
                    `;

                    // إظهار علامة الصح بعد ثانية واحدة
                    setTimeout(() => {
                        const circleLoader = document.querySelector('.circle-loader');
                        if (circleLoader) {
                            circleLoader.classList.add('load-complete');
                            const checkmark = document.querySelector('.checkmark');
                            if (checkmark) {
                                checkmark.style.display = 'block';
                            }
                        }
                    }, 1000);
                    break;

                case 'downloading':
                    // تحديث شريط التقدم
                    const progressBar = document.querySelector('.progress-fill');
                    const progressText = document.querySelector('.progress-text');

                    if (progressBar && progressText) {
                        const percent = Math.round(data.progress.percent);
                        progressBar.style.width = `${percent}%`;
                        progressText.textContent = `${percent}%`;

                        // إذا اكتمل التحميل، قم بإظهار رسالة "جاري التثبيت"
                        if (percent >= 100) {
                            // إظهار رسالة "جاري التثبيت" بعد اكتمال التحميل
                            setTimeout(() => {
                                const downloadProgress = document.getElementById('download-progress');
                                if (downloadProgress) {
                                    const downloadButton = document.getElementById('download-update-btn');
                                    if (downloadButton) {
                                        downloadButton.style.display = 'none';
                                    }

                                    const installMessage = document.createElement('div');
                                    installMessage.className = 'installing-message animate__animated animate__fadeIn';
                                    installMessage.innerHTML = `
                                        <i class="fas fa-cog fa-spin"></i>
                                        <p>جاري تثبيت التحديث...</p>
                                        <p class="small-text">سيتم إعادة تشغيل التطبيق تلقائياً بعد الانتهاء</p>
                                    `;

                                    // إضافة رسالة التثبيت بعد شريط التقدم
                                    const updateAvailable = document.querySelector('.update-available');
                                    if (updateAvailable) {
                                        updateAvailable.appendChild(installMessage);
                                    }

                                    // إرسال طلب تثبيت التحديث تلقائياً
                                    setTimeout(() => {
                                        window.api.send('install-update');
                                    }, 2000);
                                }
                            }, 500);
                        }
                    }
                    break;

                case 'downloaded':
                    updateStatus.innerHTML = `
                        <div class="update-downloaded animate__animated animate__fadeIn">
                            <div class="success-animation">
                                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                                </svg>
                            </div>
                            <p>تم تنزيل التحديث بنجاح!</p>
                            <p class="restart-message">جاري إعادة تشغيل التطبيق لتثبيت التحديث...</p>
                            <div class="restart-progress">
                                <div class="restart-progress-fill"></div>
                            </div>
                        </div>
                    `;

                    // بدء تأثير شريط التقدم لإعادة التشغيل
                    setTimeout(() => {
                        const restartProgressFill = document.querySelector('.restart-progress-fill');
                        if (restartProgressFill) {
                            restartProgressFill.style.width = '100%';
                        }

                        // إرسال طلب تثبيت التحديث تلقائياً بعد 3 ثوان
                        setTimeout(() => {
                            window.api.send('install-update');
                        }, 3000);
                    }, 500);
                    break;

                case 'error':
                    updateStatus.innerHTML = `
                        <div class="update-error animate__animated animate__fadeIn">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>حدث خطأ أثناء التحقق من التحديثات</p>
                            <p class="error-message">${data.error || 'خطأ غير معروف'}</p>
                            <button id="retry-update-btn" class="primary-button">
                                <i class="fas fa-sync-alt"></i>
                                إعادة المحاولة
                            </button>
                        </div>
                    `;

                    // إضافة مستمع حدث لزر إعادة المحاولة
                    document.getElementById('retry-update-btn').addEventListener('click', () => {
                        document.getElementById('check-updates-btn').click();
                    });
                    break;

                default:
                    console.log('حالة تحديث غير معروفة:', data.status);
                    break;
            }
        });

        // التحقق تلقائيًا من التحديثات عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', () => {
            // تحديث الإصدار الحالي
            updateCurrentVersion();

            // التحقق من التحديثات بعد نصف ثانية
            setTimeout(() => {
                document.getElementById('check-updates-btn').click();
            }, 500);
        });
    </script>
</body>
</html>
